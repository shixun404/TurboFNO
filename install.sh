#!/bin/bash

set -e

# ç¡®ä¿çŽ¯å¢ƒå˜é‡ PROJECT_ROOT å·²è®¾ç½®
if [ -z "$PROJECT_ROOT" ]; then
  echo "âŒ Please set PROJECT_ROOT first:"
  echo "   export PROJECT_ROOT=/path/to/TurboFNO"
  exit 1
fi

VARIANT_DIRS=(
  "1D_A_exp_fft+cgemm+ifft"
  "1D_B_exp_fused_fft_cgemm+ifft"
  "1D_C_exp_fft+fused_cgemm_ifft"
  "1D_D_exp_fused_fft_cgemm_ifft"
  "1D_E_baseline"
  "2D_A_exp_fft+cgemm+ifft"
  "2D_B_exp_fused_fft_cgemm+ifft"
  "2D_C_exp_fft+fused_cgemm_ifft"
  "2D_D_exp_fused_fft_cgemm_ifft"
  "2D_E_baseline"
)

# === clinea ===
if [ "$1" == "clean" ]; then
  echo "ðŸ§¹ Cleaning all build directories..."
  for dir in "${VARIANT_DIRS[@]}"; do
    if [ -d "fusion_variants/$dir/build" ]; then
      echo "âŒ Removing $dir/build ..."
      rm -rf "fusion_variants/$dir/build"
    fi
  done
  echo "âœ… All build directories removed."
  echo "ðŸ§¼ Removing generated envpath.sh ..."
  rm -f envpath.sh
  echo "âœ… Done."
  exit 0
fi

# === ç¼–è¯‘æ‰€æœ‰ variants ===
echo "ðŸ›   Starting compilation of all TurboFNO variants..."

# æ¸…ç©ºæˆ–åˆå§‹åŒ– envpath.sh
echo "# Auto-generated by install.sh" > envpath.sh

for dir in "${VARIANT_DIRS[@]}"; do
  echo "ðŸ”¹ Building $dir ..."
  cd "fusion_variants/$dir"
  mkdir -p build && cd build
  cmake ..
  make -j
  echo "export PATH=\$PATH:$(pwd)" >> "$PROJECT_ROOT/envpath.sh"
  cd ../../..
done

echo "âœ… All variants built successfully!"
echo "ðŸ“¦ PATH entries for executables saved to: $PROJECT_ROOT/envpath.sh"
echo "ðŸ“Œ To use them, run:"
echo "    source $PROJECT_ROOT/envpath.sh"
